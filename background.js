var yamaoptions_bg={MESSAE_TYPE:"",STATE:"",PHASE:0},prevtabid,currentDownloadId,writeStorage=function(a){var b=function(c){console.log("Write failed: "+c.toString())};webkitRequestFileSystem(PERSISTENT,1048576,function(c){c.root.getFile("yamaconv.txt",{create:!0},function(e){e.createWriter(function(d){var f=!1,g=new Blob([a],{type:"text/plain"});d.onwriteend=function(h){console.log("Write completed.");f||(d.seek(g.size),d.truncate(g.size),f=!0)};d.onerror=function(h){console.log("Write failed: "+
h.toString())};d.write(g)},b)},b)},b)},readStorage=function(){window.webkitRequestFileSystem(PERSISTENT,1048576,function(a){a.root.getFile("yamaconv.txt",{create:!0},function(b){b.file(function(c){var e=new FileReader;e.onloadend=function(d){try{yamaoptions_bg=JSON.parse(d.target.result),console.log("readStorage Read data: "+d.target.result)}catch(f){console.log("readStorage Read error: "+f),console.log("readStorage e.target.result: "+d.target.result)}};e.readAsText(c)})})})},deleteStorage=function(){window.webkitRequestFileSystem(window.PERSISTENT,
0,function(a){a.root.getFile("yamaconv.txt",{create:!1},function(b){b.remove(function(){})})})},downloadListener=function(a){console.log("downloads.onChanged");a.id==currentDownloadId&&"state"in a&&("complete"==a.state.current?(console.log("chrome.downloads.download complete!!"),yamaoptions_bg.MESSAE_TYPE="downloads",yamaoptions_bg.STATE="success",chrome.tabs.sendMessage(prevtabid,yamaoptions_bg,null)):"interrupted"==a.state.current?(console.log("chrome.downloads.download failed!!"),yamaoptions_bg.MESSAE_TYPE=
"downloads",yamaoptions_bg.STATE="error",chrome.tabs.sendMessage(prevtabid,yamaoptions_bg,null)):console.log("downloads.onChanged state = "+a.state.current))};console.log("yamaconv background start");chrome.runtime.onInstalled.addListener(function(){try{chrome.contextMenus.create({id:"context-yamaconv",title:"YamarecoYamapConv(&Y)",contexts:["all"],type:"normal"})}catch(a){}});chrome.runtime.onStartup.addListener(function(){console.log("yamaconv background onStartup")});
chrome.runtime.onMessage.addListener(function(a,b,c){currentDownloadId=0;console.log("chrome.runtime.onMessage cmd: "+a.cmd);if("downloadFile"==a.cmd)return console.log("chrome.runtime.onMessage chrome.downloads.download"),a.firstFlg&&chrome.downloads.onChanged.addListener(downloadListener),chrome.downloads.download({url:a.jpglist.url,filename:a.jpglist.fname},function(e){console.log("downloadId = "+e);currentDownloadId=e}),!0;if("setInputField"==a.cmd)return c(!1),setTimeout(function(){console.log("yamaconv background3 start");
yamaoptions_bg.MESSAE_TYPE=a.cmd;yamaoptions_bg.PHASE=a.phase;chrome.tabs.sendMessage(prevtabid,yamaoptions_bg,null)},100),!0;if("isSaveoption"==a.cmd)return writeStorage(a.opt),yamaoptions_bg=JSON.parse(a.opt),!0;if("isReadoption"==a.cmd)return c(JSON.stringify(yamaoptions_bg)),!0;c(!1);setTimeout(function(){console.log("yamaconv background3 start");yamaoptions_bg.MESSAE_TYPE=a.cmd;chrome.tabs.sendMessage(prevtabid,yamaoptions_bg,null)},Number(yamaoptions_bg.JISSEKIBTNTIMER));return!0});
chrome.browserAction.onClicked.addListener(function(a){console.log("yamaconv background Toolbar onClicked start");yamaoptions_bg.MESSAE_TYPE="yamaconv";prevtabid=a.id;chrome.tabs.sendMessage(a.id,yamaoptions_bg,function(b){console.log("chrome.runtime.lastError2 = "+chrome.runtime.lastError);console.log("response = "+b);1!=b&&alert("\u62e1\u5f35\u6a5f\u80fd\u306e\u8d77\u52d5\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u30d6\u30e9\u30a6\u30b6\u3092\u518d\u8d77\u52d5\u3057\u3001\u518d\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u306a\u304a\u30e4\u30de\u30ec\u30b3\u3084Yamap\u306e\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001\u3059\u3050\u306b\u62e1\u5f35\u6a5f\u80fd\u3092\u5b9f\u884c\u3059\u308b\u3068\u3053\u306e\u30a8\u30e9\u30fc\u3068\u306a\u308b\u5834\u5408\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002")});
console.log("chrome.runtime.lastError1 = "+chrome.runtime.lastError)});
chrome.contextMenus.onClicked.addListener(function(a,b){console.log("yamaconv background RightMenu onClicked start");"context-yamaconv"===a.menuItemId&&(yamaoptions_bg.MESSAE_TYPE="yamaconv",prevtabid=b.id,chrome.tabs.sendMessage(b.id,yamaoptions_bg,function(c){console.log("chrome.runtime.lastError2 = "+chrome.runtime.lastError);console.log("response = "+c);1!=c&&alert("\u62e1\u5f35\u6a5f\u80fd\u306e\u8d77\u52d5\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u30d6\u30e9\u30a6\u30b6\u3092\u518d\u8d77\u52d5\u3057\u3001\u518d\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u306a\u304a\u30e4\u30de\u30ec\u30b3\u3084Yamap\u306e\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001\u3059\u3050\u306b\u62e1\u5f35\u6a5f\u80fd\u3092\u5b9f\u884c\u3059\u308b\u3068\u3053\u306e\u30a8\u30e9\u30fc\u3068\u306a\u308b\u5834\u5408\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002")}),console.log("chrome.runtime.lastError1 = "+
chrome.runtime.lastError))});console.log("yamaconv background end");
