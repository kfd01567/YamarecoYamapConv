var yamaoptions={MESSAE_TYPE:"",STATE:"",PHASE:0},recodata={recoid:"",recotitle:"",recodetail:"",recogpx:"",startdate:"",starttime:"",enddate:"",endtime:"",picmess:[]},stateElement,nextpicindex,totalpiccount,errorFlg,yamarecodata;
chrome.runtime.onMessage.addListener(function(k,e,g){var l,B=function(a){try{var c=a.URL.match(/detail-\d+/);c=c[0].substring(7)}catch(b){console.log("*** yamaconv getRecoId exception = "+b),c=null}return c},E=function(a){recodata.picmess=[];try{a.getElementById("myState").remove()}catch(m){}var c=B(a);if(null==c)console.log("*** yamaconv downloadFiles not found RecoId");else{recodata.recoid=c;try{var b=a.getElementById("pagetitle").firstChild.nextSibling;recodata.recotitle=b.innerText;b.insertAdjacentHTML("beforebegin",
'\n          <div id="myState" style="color:red; background-color:pink; border: 1px solid red;">YamarecoYamap\u62e1\u5f35\u6a5f\u80fd\u52d5\u4f5c\u4e2d\u3067\u3059</div>\n          ');stateElement=a.getElementById("myState")}catch(m){console.log("*** yamaconv downloadFiles exception = "+m);alert("\u30bf\u30a4\u30c8\u30eb\u304c\u53d6\u5f97\u3067\u304d\u306a\u3044\u305f\u3081\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002");return}try{var d=a.URL.lastIndexOf("/");recodata.recogpx=a.URL.substring(0,
d)+"/track-"+c+".gpx";var f=a.getElementById("record_detail"),p=f.getElementsByTagName("td")[0].innerText;f=p.match(/(\d\d\d\d)\u5e74(\d+)\u6708(\d+)\u65e5/);recodata.startdate=RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3;d=p.indexOf("\uff5e");0<d?(f=p.substring(d).match(/(\d\d\d\d)\u5e74(\d+)\u6708(\d+)\u65e5/),recodata.enddate=RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3):recodata.enddate=recodata.startdate;f=a.querySelector("div#c_time1");var C=f.querySelector("span.block.label2.start");recodata.starttime=C.querySelector(".time.leave.label2").innerText;
null==recodata.starttime.match(/\d\d:\d\d/)&&(recodata.starttime="08:00");var w=f.querySelectorAll("span.block.label2.end");recodata.endtime=w[w.length-1].querySelector(".time.arrive.label2").innerText;null==recodata.endtime.match(/\d\d:\d\d/)&&(recodata.endtime="17:00");f=a.querySelector("div.impression");recodata.recodetail=f.querySelector("div.txt").innerText;f=a.querySelector("div.photo_area");var v=f.querySelectorAll("div.item");if(null==v||0==v.length)alert("\u30da\u30fc\u30b8\u5185\u306b\u5199\u771f\u304c\u306a\u3044\u305f\u3081\u3001\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u30021\u3064\u4ee5\u4e0a\u306e\u5199\u771f\u304c\u5fc5\u8981\u3067\u3059\u3002");
else{var q;totalpiccount=v.length;for(q=0;q<totalpiccount;q++){var x=v[q].firstChild,n=x.firstChild.getAttribute("data-original");n=n.replace("t_","");console.log("*** yamaconv downloadFiles imgElements = "+n);var r=x.nextSibling.innerHTML,y=r.indexOf("<div ");r=0==y?"":r.substring(0,y);console.log("*** yamaconv downloadFiles strComment = "+r);b=".jpg";var z;-1!=(z=n.lastIndexOf("."))&&(b=n.substring(z));d=""+q;1==d.length?d="00"+d:2==d.length&&(d="0"+d);recodata.picmess.push({fname:"reco_"+c+"_"+
d+b,url:"https://yamareco.org"+n,comment:r,state:""})}a.body.insertAdjacentHTML("afterEnd",`
          <a id="myDownload" href="#" download="${"reco_"+c+".json"}">download</a>
          `);a.getElementById("myDownload").addEventListener("click",D);errorFlg=!1;nextpicindex=1;chrome.runtime.sendMessage({cmd:"downloadFile",jpglist:recodata.picmess[0],firstFlg:!0},function(m){console.log("*** yamaconv downloadFiles sendMessage flg = "+m)})}}catch(m){console.log("*** yamaconv downloadFiles exception = "+m)}}},D=function(){console.log("*** yamaconv handleDownload start");var a=new Uint8Array([239,187,191]);a=new Blob([a,JSON.stringify(recodata)],{type:"text/plain"});if(window.navigator.msSaveBlob){var c=
"reco_"+recodata.recoid+".json";window.navigator.msSaveBlob(a,c);window.navigator.msSaveOrOpenBlob(a,c)}else{const b=window.URL.createObjectURL(a);document.getElementById("myDownload").href=b;setTimeout(()=>{window.URL.revokeObjectURL(b)},1E3)}},A=function(a,c){var b;for(b=0;b<a.length;b++)if(a[b].firstChild.innerText==c)return a[b]};e=function(a,c){var b;for(b=0;b<a.length;b++)if(a[b].innerText==c)return a[b]};var F=function(a){console.log("*** yamaconv handleUpload start");a=a.target.files[0];var c=
new FileReader;c.onload=function(b){yamarecodata=JSON.parse(b.target.result);var d=new Event("click",{bubbles:!0,cancelable:!1});b=new Event("input",{bubbles:!0,cancelable:!1});var f=A(document.querySelectorAll("li.el-select-dropdown__item"),"\u30cf\u30a4\u30ad\u30f3\u30b0");f.dispatchEvent(d);f=A(document.querySelectorAll("li.el-select-dropdown__item"),"\u516c\u958b");f.dispatchEvent(d);d=document.querySelector("input.ActivityEditor__Input");t(d,yamarecodata.recotitle);d.dispatchEvent(b);d=document.querySelector("textarea.ActivityEditor__TextArea.Textarea__NoScrollbar");
t(d,yamarecodata.recodetail);d.dispatchEvent(b);for(d=0;d<l.length;d++)t(l[d],yamarecodata.picmess[d].comment),l[d].dispatchEvent(b);b=document.querySelectorAll("input.el-input__inner");t(b[0],yamarecodata.startdate);b[0].dispatchEvent(new Event("input",{bubbles:!0,cancelable:!1}));t(b[2],yamarecodata.enddate);b[2].dispatchEvent(new Event("input",{bubbles:!0,cancelable:!1}));chrome.runtime.sendMessage({cmd:"setInputField",phase:1},function(p){console.log("*** yamaconv sendMessage flg = "+p)});console.log("*** yamaconv success dispatchEvent")};
c.readAsText(a)},t=function(a,c){a.value=c;a.setAttribute("value",c+"");try{a._value=c}catch(b){}try{a.defaultValue=c}catch(b){console.log("*** yamaconv setInputValue failed to set defaultValue : "+b)}},h=function(){try{console.log("*** yamaconv mystart start");var a=window;if("object"===typeof a){var c=a.top.document,b=c.title;console.log('title = "'+b+'"');0<=b.indexOf("\u30e4\u30de\u30ec\u30b3")?(console.log("\u30e4\u30de\u30ec\u30b3\u30da\u30fc\u30b8\u3067\u5b9f\u884c\u3055\u308c\u307e\u3057\u305f"),
E(c)):0<=b.indexOf("YAMAP")?(console.log("YAMAP\u30da\u30fc\u30b8\u3067\u5b9f\u884c\u3055\u308c\u307e\u3057\u305f"),l=c.querySelectorAll("textarea.ActivityImageItem__TextArea.Textarea__NoScrollbar"),null==l||0==l.length?alert("\u5199\u771f\u304c\u307e\u3060\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u306a\u3044\u3088\u3046\u3067\u3059\u30021\u679a\u4ee5\u4e0a\u306e\u5199\u771f\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u304b\u3089\u672c\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002"):
(null==c.getElementById("myUpload")&&(c.querySelector("h1.ActivityEditor__Heading").insertAdjacentHTML("afterend",'\n          <div id="myUploadMess" style="color: blue">\u30e4\u30de\u30ec\u30b3\u30c7\u30fc\u30bf(JSON\u30d5\u30a1\u30a4\u30eb)\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044)<input type="file" id="myUpload" accept="application/json"></div><br><div id="myUploadField" style="color: red"></div>\n          '),c.getElementById("myUpload").addEventListener("change",F)),scrollTo(0,0))):
alert("\u672c\u62e1\u5f35\u6a5f\u80fd\u306f\u30e4\u30de\u30ec\u30b3\u307e\u305f\u306fYamap\u30b5\u30a4\u30c8\u3067\u306e\u307f\u6709\u52b9\u3067\u3059\u3002")}else console.log("*** yamaconv mystart error ! external.menuArguments is not object.")}catch(d){console.log("*** yamaconv mystart exception = "+d)}};yamaoptions=k;console.log("yamaconv addListener start : "+yamaoptions.MESSAE_TYPE);g(!0);if("yamaconv"==yamaoptions.MESSAE_TYPE)console.log("yamaconv start"),h(),console.log("yamaconv end");else if("downloads"==
yamaoptions.MESSAE_TYPE)console.log("yamaconv1 start"),999==nextpicindex?("success"!=yamaoptions.STATE&&(recodata.recogpx="none"),window.top.document.getElementById("myDownload").click(),window.top.document.getElementById("myDownload").remove(),stateElement&&stateElement.remove(),errorFlg?alert('\u5199\u771f\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002JSON\u30d5\u30a1\u30a4\u30eb\u4e2d\u3067"error"\u3068\u306a\u3063\u3066\u3044\u308b\u7b87\u6240\u3092\u78ba\u8a8d\u3057\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u672c\u62e1\u5f35\u6a5f\u80fd\u3092\u518d\u5ea6\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002'):
50<totalpiccount?alert("\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002\u5199\u771f\u306e\u6570\u304c50\u3092\u8d85\u3048\u3066\u3044\u307e\u3059\u3002Yamap\u306b\u30c7\u30fc\u30bf\u79fb\u884c\u3059\u308b\u5834\u5408\u3001\u5236\u9650\u306b\u3088\u308a\u79fb\u884c\u3067\u304d\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002"):alert("\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002")):nextpicindex==totalpiccount?(recodata.picmess[nextpicindex-
1].state=yamaoptions.STATE,chrome.runtime.sendMessage({cmd:"downloadFile",jpglist:{fname:"track-"+recodata.recoid+".gpx",url:recodata.recogpx,comment:"",state:""},firstFlg:!1},function(a){console.log("*** yamaconv sendMessage flg = "+a)}),nextpicindex=999):("error"==yamaoptions.STATE&&(errorFlg=!0),recodata.picmess[nextpicindex-1].state=yamaoptions.STATE,chrome.runtime.sendMessage({cmd:"downloadFile",jpglist:recodata.picmess[nextpicindex],firstFlg:!1},function(a){console.log("*** yamaconv sendMessage flg = "+
a)}),nextpicindex++,stateElement&&(stateElement.innerText="\u73fe\u5728\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6570: "+nextpicindex+" / \u5408\u8a08: "+totalpiccount));else if("setInputField"==yamaoptions.MESSAE_TYPE){if(new Event("input",{bubbles:!0,cancelable:!1}),k=new Event("click",{bubbles:!0,cancelable:!1}),console.log("*** yamaconv setInputField yamaoptions.PHASE = "+yamaoptions.PHASE),0!=yamaoptions.PHASE)if(1==yamaoptions.PHASE)e=document.querySelectorAll("input.el-input__inner"),console.log("*** yamaconv focus1"),
e[1].focus(),chrome.runtime.sendMessage({cmd:"setInputField",phase:2},function(a){console.log("*** yamaconv sendMessage flg = "+a)});else if(2==yamaoptions.PHASE){g=document.querySelectorAll("ul.el-time-spinner__list");console.log("*** yamaconv ulItems.length = "+g.length);var u=yamarecodata.starttime.split(":");h=e(g[0].querySelectorAll("li.el-time-spinner__item"),u[0]);h.dispatchEvent(k);h=e(g[1].querySelectorAll("li.el-time-spinner__item"),u[1]);h.dispatchEvent(k);e=document.querySelectorAll("input.el-input__inner");
console.log("*** yamaconv focus2");e[1].blur();chrome.runtime.sendMessage({cmd:"setInputField",phase:3},function(a){console.log("*** yamaconv sendMessage flg = "+a)})}else 3==yamaoptions.PHASE?(e=document.querySelectorAll("input.el-input__inner"),console.log("*** yamaconv focus2"),e[3].focus(),chrome.runtime.sendMessage({cmd:"setInputField",phase:4},function(a){console.log("*** yamaconv sendMessage flg = "+a)})):4==yamaoptions.PHASE?(g=document.querySelectorAll("ul.el-time-spinner__list"),console.log("*** yamaconv ulItems.length = "+
g.length),u=yamarecodata.endtime.split(":"),h=e(g[3].querySelectorAll("li.el-time-spinner__item"),u[0]),h.dispatchEvent(k),h=e(g[4].querySelectorAll("li.el-time-spinner__item"),u[1]),h.dispatchEvent(k),e=document.querySelectorAll("input.el-input__inner"),console.log("*** yamaconv focus2"),e[3].blur(),chrome.runtime.sendMessage({cmd:"setInputField",phase:5},function(a){console.log("*** yamaconv sendMessage flg = "+a)})):5==yamaoptions.PHASE?(e=document.querySelectorAll("input.el-input__inner"),console.log("*** yamaconv focus3"),
e[0].focus(),chrome.runtime.sendMessage({cmd:"setInputField",phase:6},function(a){console.log("*** yamaconv sendMessage flg = "+a)})):6==yamaoptions.PHASE&&alert("\u30e4\u30de\u30ec\u30b3\u30c7\u30fc\u30bf\u306e\u5165\u529b\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002OK\u3092\u62bc\u3057\u3066\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9589\u3058\u3001\u305d\u306e\u5f8cTab\u30ad\u30fc\u30924\u56de\u4ee5\u4e0a\u62bc\u4e0b\u3057\u3066\u5165\u529b\u3092\u78ba\u5b9a\u3055\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u305d\u306e\u5f8c\u300c\u5909\u66f4\u5185\u5bb9\u3092\u4fdd\u5b58\u300d\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30dc\u30bf\u30f3\u62bc\u4e0b\u5f8c\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066gpx\u30d5\u30a1\u30a4\u30eb\u3092\u624b\u52d5\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002")}else"isCalculated"==
yamaoptions.MESSAE_TYPE?(console.log("yamaconv2 start"),e=window.top.document.getElementsByName("register"),1>e.length||e[0].click()):"isHanei"==yamaoptions.MESSAE_TYPE&&(console.log("yamaconv3 start"),e=window.top.document.getElementsByName("calculate"),1>e.length||(chrome.runtime.sendMessage({cmd:"isCalculated"},function(a){console.log("*** yamaconv ssEntryHelper sendMessage flg = "+a)}),console.log("*** yamaconv ssEntryHelper calculate push"),e[0].click()))});
